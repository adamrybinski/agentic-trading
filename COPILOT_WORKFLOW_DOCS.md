# Copilot-Triggered CI/CD Workflow Documentation

## Overview

This document describes the PR-comment-triggered CI/CD system that responds to Pull Request comments and provides intelligent failure reporting for the agentic-trading repository.

## 🎯 Key Features

### 1. **PR Comment Triggering**
The workflow automatically detects PR comments and runs tests:
- **PR review comments**: Any comment on a PR review triggers tests
- **Simplified logic**: No longer requires specific patterns or bot detection
- **Focused approach**: Only PR-related comments trigger workflows

### 2. **Smart Test Triggering**
- **Immediate response**: Tests run when PR comments are made
- **30-second buffer**: Allows for multiple rapid commits to complete
- **PR-focused**: Only listens to PR comments, not pushes or issues

### 3. **PR-Based Failure Reporting**
When tests fail, the system:
- **Comments on PR**: Failure details are added as PR review comments
- **AI-enhanced analysis**: Uses GitHub Models for failure analysis
- **Agent triggering**: Comments include @copilot mentions to trigger agent sessions
- **Actionable feedback**: Provides specific recommendations for fixes

### 4. **Simplified Workflow**
The updated workflow:
- Removes push-based triggers that could cause conflicts
- Eliminates agentic session triggers that were causing issues
- Focuses on PR-driven development workflow
- Provides immediate feedback on PR comments

## 🔧 Workflow Files

### Primary Workflows

1. **`.github/workflows/copilot-triggered-tests.yml`**
   - Main Copilot-responsive workflow
   - Handles test execution and failure management
   - Creates AI-enhanced issues

2. **`.github/workflows/ci-tests.yml`** (Enhanced)
   - Traditional CI/CD with improved issue creation
   - Issues assigned to adamrybinski with proper attribution

### Testing Utilities

3. **`test_copilot_workflow.py`**
   - Comprehensive test suite for workflow functionality
   - Validates trigger logic, AI integration, and issue creation
   - Simulates failure scenarios

## 🚀 Workflow Triggers

### Automatic Triggers

```yaml
# Triggered by PR comments only
on:
  pull_request_review_comment:
    types: [created]
```

### Trigger Conditions

The workflow runs when:
1. **PR review comments** are created (any comment triggers tests)
2. **Manual execution** for testing purposes

### Wait Strategy

```yaml
# Prevents multiple overlapping runs
wait-for-copilot:
  needs: check-copilot-completion
  steps:
    - name: Wait for potential additional commits
      run: sleep 30
```

## 🔍 Test Execution

### Comprehensive Test Suite

The workflow runs:
- **Workflow functionality tests** (`test_workflow.py`)
- **Prolog generation tests** (`test_prolog_generation.py`)
- **Prolog analysis tests** (`test_prolog_analysis.py`)
- **GitHub Models integration tests**
- **File structure validation**
- **SWI-Prolog compatibility checks**

### Failure Simulation

For testing purposes, commits containing `test-failure-simulation` trigger intentional failures to validate the issue creation process.

## 🤖 PR-Based Failure Reporting

### GitHub Models Integration

When tests fail, the system:

1. **Collects failure context**:
   ```bash
   - Branch and commit information
   - Test output logs (last 50 lines)
   - Error messages and exit codes
   ```

2. **Generates AI analysis**:
   ```python
   prompt = f"""
   Analyze this CI/CD test failure and provide:
   1. Root cause analysis (2-3 sentences)
   2. Recommended fix (bullet points)
   3. Priority level (High/Medium/Low)
   4. Estimated effort (Quick fix/Medium/Complex)
   """
   ```

3. **Comments on PR**:
   - AI-generated summary posted as PR review comment
   - Technical details and failure analysis
   - Actionable next steps with @copilot mention
   - Automatic agent session triggering

### Comment Format

```markdown
## 🚨 Test Failure Report

### 📊 Failure Summary
[AI-generated analysis of root cause and recommendations]

### 📋 Technical Details
- Workflow: [workflow name]
- Branch: [branch name]
- Commit: [commit hash]
- Triggered by: [actor]

### 🎯 Next Steps
1. Review workflow logs
2. Check test artifacts
3. Fix failing tests
4. Push new commit (triggers re-test)

@copilot Please analyze this test failure and suggest fixes.

---
*Auto-generated by CI/CD workflow failure*
```

## 🌿 Branch Monitoring (Removed)

### Why Branch Monitoring Was Removed

Branch monitoring functionality has been removed because:
- It was tied to push events which are no longer supported
- The new workflow focuses only on PR-based development
- Branch tracking is better handled through PR creation workflows

### Previous Functionality (Now Disabled)

The workflow previously monitored all branches and created issues for:
- Branches with commits but no associated PR
- Active development branches without proper tracking

This functionality has been moved to separate workflows focused on PR management.

## 🧪 Testing and Validation

### Running Tests

```bash
# Run the comprehensive test suite
python test_copilot_workflow.py

# Test specific scenarios
python test_copilot_workflow.py --scenario trigger-detection
python test_copilot_workflow.py --scenario ai-summary
python test_copilot_workflow.py --scenario failure-simulation
```

### Test Coverage

The test suite validates:
- ✅ Copilot completion detection
- ✅ Regular user comment filtering
- ✅ AI summary generation
- ✅ Branch monitoring logic
- ✅ Issue creation formatting
- ✅ Failure simulation triggers

### Expected Results

```bash
🎯 Overall: 11/11 tests passed
🎉 All tests passed!
```

## 🔐 Security and Permissions

### Required Permissions

```yaml
permissions:
  contents: read      # Read repository content
  pull-requests: write # Create PR comments and read PR information
  actions: write      # Trigger other workflows
```

### Issue Attribution

Issues created by other workflows are assigned to:
- **Assignee**: adamrybinski (updated from copilot-swe-agent)
- **Auto-assignment**: All new issues automatically assigned to adamrybinski
- **Contact**: adam@compose.systems

### Token Management

- Uses `${{ secrets.GITHUB_TOKEN }}` for repository operations
- Falls back gracefully when GitHub Models API unavailable
- Secure handling of AI model interactions

## 📊 Monitoring and Debugging

### Workflow Logs

Each run provides detailed logs:
- Trigger detection results
- Test execution summaries
- AI analysis attempts
- Issue creation confirmations

### Test Artifacts

Preserved artifacts include:
- Test result JSON files
- Generated Prolog files
- Error logs and outputs

### Issue Tracking

All automated issues include:
- Direct links to workflow runs
- Commit comparison links
- Detailed failure context
- Suggested resolution paths

## 🎛️ Configuration

### Environment Variables

```yaml
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Required
  # Optional: Custom AI model selection
  # Optional: Test timeout overrides
```

### Customization Options

- **Test timeout**: Modify `timeout-minutes` in workflow
- **Wait duration**: Adjust sleep time in wait-for-copilot
- **AI model selection**: Configure in github_models_analyzer
- **Branch filters**: Modify branch monitoring logic

## 🚀 Future Enhancements

Planned improvements:
- **PR auto-creation** for qualifying branches
- **Slack/Discord notifications** for critical failures
- **Performance trend analysis** over time
- **Custom AI prompt templates** per failure type
- **Integration with project management tools**

---

*This documentation covers the PR-comment-triggered CI/CD workflow system with focus on PR-based development and failure reporting.*